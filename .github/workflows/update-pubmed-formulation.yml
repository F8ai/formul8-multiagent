name: Update PubMed Articles for Formulation Agent

on:
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Fetch latest PubMed articles
        run: |
          echo "ğŸ“š Fetching latest formulation-related articles from PubMed..."
          node scripts/fetch-pubmed-formulation.js
          
      - name: Check if new articles were found
        id: check_changes
        run: |
          if git diff --quiet agents/science-agent/data/index.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new articles found"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… New articles found!"
            
            # Show what changed
            echo ""
            echo "ğŸ“Š Changes:"
            git diff --stat agents/science-agent/data/index.json
          fi

      - name: Upload to S3
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "ğŸ“¤ Uploading updated index to S3..."
          aws s3 cp agents/science-agent/data/index.json \
            s3://formul8-platform-deployments/data/science/index.json \
            --storage-class INTELLIGENT_TIERING
          
          echo "âœ… S3 upload complete"
          echo "ğŸ”— S3 URI: s3://formul8-platform-deployments/data/science/index.json"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1

      - name: Invalidate Formulation-Agent RAG Cache
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "ğŸ”„ Invalidating formulation-agent RAG cache..."
          
          # Send cache-clear request to formulation-agent
          response=$(curl -s -X POST https://formulation-agent.f8.syzygyx.com/api/cache/clear \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.FORMUL8_API_KEY }}" \
            -d '{"source":"pubmed-update"}' 2>&1 || echo '{"status":"no-endpoint"}')
          
          echo "Response: $response"
          
          # Test RAG with new data
          echo ""
          echo "ğŸ§ª Testing RAG with updated data..."
          test_response=$(curl -s -X POST https://formulation-agent.f8.syzygyx.com/api/chat \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.FORMUL8_API_KEY }}" \
            -d '{"message":"What are the latest findings on cannabis extraction?","plan":"standard"}' 2>&1 || echo '{"error":"test-failed"}')
          
          # Check if RAG is working
          if echo "$test_response" | grep -q '"papersRetrieved"'; then
            papers=$(echo "$test_response" | grep -o '"papersRetrieved":[0-9]*' | grep -o '[0-9]*')
            echo "âœ… RAG active: Retrieved $papers papers"
          else
            echo "âš ï¸  RAG status unknown (agent may not be deployed yet)"
          fi

      - name: Commit updated index
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add agents/science-agent/data/index.json
          git commit -m "chore: Update PubMed articles for formulation RAG [automated]"
          
      - name: Push changes
        if: steps.check_changes.outputs.changed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  PubMed Update Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "âœ… New articles added"
            echo "ğŸ“¤ Uploaded to S3"
            echo "ğŸ“ Committed to repository"
            
            # Extract stats from index
            if [ -f agents/science-agent/data/index.json ]; then
              total=$(jq -r '.totalPapers' agents/science-agent/data/index.json)
              updated=$(jq -r '.lastUpdated' agents/science-agent/data/index.json)
              echo ""
              echo "ğŸ“Š Total papers: $total"
              echo "ğŸ•’ Last updated: $updated"
            fi
          else
            echo "â„¹ï¸  No new articles found"
            echo "ğŸ“… Next check: Tomorrow at 2 AM UTC"
          fi
          
          echo ""
          echo "ğŸ¯ Formulation-agent will use updated data for RAG"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ PubMed update failed!"
          echo "Check logs for details"

