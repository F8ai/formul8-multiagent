<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul8 Baseline Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px 20px;
            background: #f8f9fa;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .grade-distribution {
            padding: 30px 20px;
        }
        
        .grade-distribution h2 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .grade-bars {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .grade-bar {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .grade-label {
            font-weight: bold;
            font-size: 1.2em;
            width: 30px;
        }
        
        .bar {
            flex-grow: 1;
            height: 40px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .bar-fill {
            height: 100%;
            transition: width 1s ease-out;
            display: flex;
            align-items: center;
            padding: 0 15px;
            color: white;
            font-weight: bold;
        }
        
        .grade-A { background: linear-gradient(90deg, #10b981, #059669); }
        .grade-B { background: linear-gradient(90deg, #3b82f6, #2563eb); }
        .grade-C { background: linear-gradient(90deg, #f59e0b, #d97706); }
        .grade-D { background: linear-gradient(90deg, #ef4444, #dc2626); }
        .grade-F { background: linear-gradient(90deg, #6b7280, #4b5563); }
        
        .controls {
            padding: 20px 40px;
            background: #f8f9fa;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        select, input {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .results-table {
            padding: 30px 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .question-cell {
            max-width: 600px;
            width: 30%;
        }
        
        .response-cell {
            max-width: none;
            width: 45%;
            font-size: 0.9em;
            color: #333;
        }
        
        .routing-cell {
            width: 12%;
            text-align: center;
            font-size: 0.9em;
        }
        
        .routing-correct {
            background-color: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .routing-incorrect {
            background-color: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .routing-unknown {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .response-preview {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            line-height: 1.6;
        }
        
        .response-preview::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .response-preview::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .response-preview::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .response-preview::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .response-preview h1, .response-preview h2, .response-preview h3 {
            margin-top: 0.5em;
            margin-bottom: 0.3em;
            color: #667eea;
        }
        
        .response-preview h1 { font-size: 1.2em; }
        .response-preview h2 { font-size: 1.1em; }
        .response-preview h3 { font-size: 1em; }
        
        .response-preview ul, .response-preview ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }
        
        .response-preview li {
            margin: 0.25em 0;
        }
        
        .response-preview p {
            margin: 0.5em 0;
        }
        
        .response-preview code {
            background: #e5e7eb;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .response-preview pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 0.5em 0;
        }
        
        .response-preview pre code {
            background: none;
            padding: 0;
            color: inherit;
        }
        
        .response-preview blockquote {
            border-left: 3px solid #667eea;
            padding-left: 10px;
            margin: 0.5em 0;
            color: #6c757d;
        }
        
        .response-preview strong {
            font-weight: 600;
            color: #333;
        }
        
        .response-preview em {
            font-style: italic;
        }
        
        .response-preview hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1em 0;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            cursor: help;
            position: relative;
        }
        
        .grade-tooltip {
            display: none;
            position: absolute;
            left: 0;
            top: 100%;
            margin-top: 5px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            min-width: 300px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
            font-weight: normal;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .grade-badge:hover .grade-tooltip {
            display: block;
        }
        
        .grade-tooltip h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 1em;
        }
        
        .grade-tooltip ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .grade-tooltip li {
            margin: 3px 0;
        }
        
        .expandable {
            cursor: pointer;
            color: #667eea;
            text-decoration: underline;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-content {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
        }
        
        .modal-close {
            float: right;
            font-size: 2em;
            cursor: pointer;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            font-size: 1.2em;
            color: #6c757d;
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            background: #e5e7eb;
            font-size: 0.8em;
            margin-right: 5px;
        }
        
        .timestamp {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .editable {
            cursor: pointer;
            position: relative;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .editable:hover {
            background-color: #f0f0f0;
        }
        
        .editable.editing {
            background-color: #fff3cd;
            border: 2px solid #ffc107;
        }
        
        .edit-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: inherit;
            font-family: inherit;
            background: white;
            resize: vertical;
            min-height: 40px;
        }
        
        .edit-textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 4px;
            font-size: inherit;
            font-family: inherit;
            background: white;
            resize: vertical;
            min-height: 80px;
        }
        
        .edit-controls {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        
        .edit-btn {
            padding: 4px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .edit-save {
            background: #28a745;
            color: white;
        }
        
        .edit-save:hover {
            background: #218838;
        }
        
        .edit-cancel {
            background: #6c757d;
            color: white;
        }
        
        .edit-cancel:hover {
            background: #5a6268;
        }
        
        .edit-icon {
            margin-left: 8px;
            opacity: 0.6;
            font-size: 0.8em;
        }
        
        .edit-icon:hover {
            opacity: 1;
        }
        
        .token-input-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .token-input-content {
            max-width: 500px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .token-input-content h3 {
            margin-top: 0;
            color: #667eea;
        }
        
        .token-input-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            margin: 10px 0;
        }
        
        .token-input-content input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .token-input-content .help-text {
            font-size: 0.9em;
            color: #6c757d;
            margin: 10px 0;
        }
        
        .token-input-content .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .token-input-content .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .token-input-content .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .token-input-content .btn-primary:hover {
            background: #764ba2;
        }
        
        .token-input-content .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .token-input-content .btn-secondary:hover {
            background: #5a6268;
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .stats-container { grid-template-columns: 1fr 1fr; }
            .question-cell, .response-cell { max-width: none; }
        }
    </style>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>🧪 Formul8 Baseline Test Dashboard</h1>
            <p class="subtitle">Comprehensive E2E Testing Results for chat.formul8.ai</p>
        </header>
        
        <div class="stats-container" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalQuestions">-</div>
                <div class="stat-label">Total Questions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">-</div>
                <div class="stat-label">Average Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgGrade">-</div>
                <div class="stat-label">Average Grade</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passRate">-</div>
                <div class="stat-label">Pass Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="routingAccuracy">-</div>
                <div class="stat-label">Routing Accuracy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgTime">-</div>
                <div class="stat-label">Avg Time (s)</div>
            </div>
        </div>
        
        <div class="grade-distribution">
            <h2>📊 Grade Distribution</h2>
            <div class="grade-bars" id="gradeBars"></div>
        </div>
        
        <div class="controls">
            <label>Filter by Grade:</label>
            <select id="gradeFilter">
                <option value="all">All Grades</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="F">F</option>
            </select>
            
            <label>Filter by Category:</label>
            <select id="categoryFilter">
                <option value="all">All Categories</option>
            </select>
            
            <label>Search:</label>
            <input type="text" id="searchInput" placeholder="Search questions...">
            
            <button class="btn" onclick="exportResults()">📥 Export CSV</button>
            <button class="btn" onclick="refreshData()">🔄 Refresh</button>
        </div>
        
        <div class="results-table">
            <h2>📋 Detailed Results</h2>
            <div id="loading" class="loading">Loading baseline results</div>
            <table id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Category</th>
                        <th>Question</th>
                        <th>Response Preview</th>
                        <th>Routing</th>
                        <th>Time (ms)</th>
                        <th>Actions</th>
                        <th>Grade</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="timestamp" id="timestamp"></div>
    </div>
    
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <div class="token-input-modal" id="tokenInputModal">
        <div class="token-input-content">
            <h3>🔑 GitHub Token Required</h3>
            <p>To create GitHub issues, you need to provide a GitHub Personal Access Token.</p>
            <div class="help-text">
                <strong>How to get a token:</strong><br>
                1. Go to GitHub Settings → Developer settings → Personal access tokens<br>
                2. Click "Generate new token (classic)"<br>
                3. Select scopes: <code>repo</code> and <code>issues</code><br>
                4. Copy the generated token
            </div>
            <input type="password" id="githubTokenInput" placeholder="Enter your GitHub Personal Access Token">
            <div class="buttons">
                <button class="btn btn-secondary" onclick="cancelTokenInput()">Cancel</button>
                <button class="btn btn-primary" onclick="saveToken()">Save Token</button>
            </div>
        </div>
    </div>
    
    <script>
        let allResults = [];
        let currentResults = [];
        let githubToken = null;
        
        // Load GitHub token from sessionStorage
        function loadGitHubToken() {
            githubToken = sessionStorage.getItem('githubToken');
        }
        
        // Save GitHub token to sessionStorage
        function saveGitHubToken(token) {
            githubToken = token;
            sessionStorage.setItem('githubToken', token);
        }
        
        // Show token input modal
        function showTokenInputModal() {
            document.getElementById('tokenInputModal').style.display = 'block';
            document.getElementById('githubTokenInput').focus();
        }
        
        // Hide token input modal
        function hideTokenInputModal() {
            document.getElementById('tokenInputModal').style.display = 'none';
            document.getElementById('githubTokenInput').value = '';
        }
        
        // Save token from modal
        function saveToken() {
            const token = document.getElementById('githubTokenInput').value.trim();
            if (!token) {
                alert('Please enter a GitHub token');
                return;
            }
            saveGitHubToken(token);
            hideTokenInputModal();
            showNotification('GitHub token saved for this session', 'success');
        }
        
        // Cancel token input
        function cancelTokenInput() {
            hideTokenInputModal();
        }
        
        // Get GitHub token (prompt if not available)
        function getGitHubToken() {
            if (!githubToken) {
                showTokenInputModal();
                return null;
            }
            return githubToken;
        }
        
        async function loadResults() {
            try {
                // Try to load the latest results file
                // Use absolute path for GitHub Pages (includes repo name)
                const response = await fetch('/formul8-multiagent/baseline-results/latest.json');
                if (!response.ok) {
                    throw new Error('Results file not found');
                }
                
                const data = await response.json();
                allResults = data.results || [];
                currentResults = allResults;
                
                renderDashboard(data);
                populateFilters();
                renderTable();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('resultsTable').style.display = 'table';
                
            } catch (error) {
                document.getElementById('loading').innerHTML = `
                    ⚠️ No test results found yet.<br><br>
                    Run baseline tests with:<br>
                    <code>npx playwright test test-baseline-e2e.spec.js</code><br><br>
                    Or check: <a href="https://github.com/F8ai/formul8-multiagent/actions">GitHub Actions</a>
                `;
            }
        }
        
        function renderDashboard(data) {
            document.getElementById('totalQuestions').textContent = data.totalQuestions;
            document.getElementById('avgScore').textContent = data.averageScore + '%';
            document.getElementById('avgGrade').textContent = data.averageGrade;
            document.getElementById('passRate').textContent = 
                ((data.passed / data.totalQuestions) * 100).toFixed(1) + '%';
            
            // Calculate routing accuracy
            const routingResults = data.results.filter(r => r.actualAgent && r.expectedAgent);
            const correctRouting = routingResults.filter(r => r.actualAgent === r.expectedAgent).length;
            const routingAccuracy = routingResults.length > 0 ? 
                ((correctRouting / routingResults.length) * 100).toFixed(1) + '%' : 'N/A';
            document.getElementById('routingAccuracy').textContent = routingAccuracy;
            
            const avgTime = data.results.reduce((sum, r) => sum + r.duration, 0) / data.results.length;
            document.getElementById('avgTime').textContent = (avgTime / 1000).toFixed(2);
            
            document.getElementById('timestamp').textContent = 
                'Last Updated: ' + new Date(data.timestamp).toLocaleString();
            
            renderGradeBars(data.results);
        }
        
        function renderGradeBars(results) {
            const gradeCount = { A: 0, B: 0, C: 0, D: 0, F: 0 };
            results.forEach(r => gradeCount[r.grade]++);
            
            const total = results.length;
            const container = document.getElementById('gradeBars');
            container.innerHTML = '';
            
            Object.entries(gradeCount).forEach(([grade, count]) => {
                const percent = (count / total) * 100;
                const bar = document.createElement('div');
                bar.className = 'grade-bar';
                bar.innerHTML = `
                    <div class="grade-label">${grade}</div>
                    <div class="bar">
                        <div class="bar-fill grade-${grade}" style="width: ${percent}%">
                            ${count} (${percent.toFixed(1)}%)
                        </div>
                    </div>
                `;
                container.appendChild(bar);
            });
        }
        
        function populateFilters() {
            const categories = [...new Set(allResults.map(r => r.category))].sort();
            const categoryFilter = document.getElementById('categoryFilter');
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
        }
        
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            currentResults.forEach((result, index) => {
                const row = document.createElement('tr');
                const gradeClass = `grade-${result.grade}`;
                
                // Build rich tooltip content
                let tooltipContent = '<h4>Grading Breakdown</h4><ul>';
                if (result.grading) {
                    tooltipContent += Object.entries(result.grading)
                        .map(([key, value]) => `<li><strong>${key}:</strong> ${value}</li>`)
                        .join('');
                }
                tooltipContent += '</ul>';
                
                // Add expected keywords if available
                if (result.expectedKeywords && result.expectedKeywords.length > 0) {
                    tooltipContent += '<h4>Expected Keywords</h4><ul>';
                    tooltipContent += result.expectedKeywords.map(kw => `<li>${kw}</li>`).join('');
                    tooltipContent += '</ul>';
                }
                
                // Format expected answer/keywords as editable
                let expectedSection = '';
                if (result.expectedKeywords && result.expectedKeywords.length > 0) {
                    expectedSection = `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                        <small style="color: #6c757d;"><strong>Expected Keywords:</strong></small>
                        <div class="editable" data-field="expectedKeywords" data-question-id="${result.id}" data-original-value="${result.expectedKeywords.join(', ')}">
                            ${result.expectedKeywords.join(', ')}<span class="edit-icon">✏️</span>
                        </div>
                    </div>`;
                } else if (result.expectedAnswer) {
                    expectedSection = `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                        <small style="color: #6c757d;"><strong>Expected Answer:</strong></small>
                        <div class="editable" data-field="expectedAnswer" data-question-id="${result.id}" data-original-value="${result.expectedAnswer}">
                            ${result.expectedAnswer}<span class="edit-icon">✏️</span>
                        </div>
                    </div>`;
                } else {
                    expectedSection = `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                        <small style="color: #6c757d;"><strong>Expected Answer:</strong></small>
                        <div class="editable" data-field="expectedAnswer" data-question-id="${result.id}" data-original-value="">
                            Click to add expected answer<span class="edit-icon">✏️</span>
                        </div>
                    </div>`;
                }
                
                // Determine routing status
                let routingStatus = 'unknown';
                let routingClass = 'routing-unknown';
                let routingText = 'Unknown';
                
                if (result.actualAgent && result.expectedAgent) {
                    if (result.actualAgent === result.expectedAgent) {
                        routingStatus = 'correct';
                        routingClass = 'routing-correct';
                        routingText = '✓ Correct';
                    } else {
                        routingStatus = 'incorrect';
                        routingClass = 'routing-incorrect';
                        routingText = '✗ Wrong';
                    }
                } else if (result.actualAgent) {
                    routingText = result.actualAgent;
                }
                
                row.innerHTML = `
                    <td>${result.questionNum}</td>
                    <td><span class="category-badge">${result.category}</span></td>
                    <td class="question-cell">
                        <div class="editable" data-field="question" data-question-id="${result.id}" data-original-value="${result.question}">
                            <div style="font-weight: 500; color: #333;">${result.question}</div>
                            <span class="edit-icon">✏️</span>
                        </div>
                        ${expectedSection}
                    </td>
                    <td class="response-cell"><div class="response-preview">${marked.parse(result.response || result.error || 'No response')}</div></td>
                    <td class="routing-cell">
                        <span class="${routingClass}" title="Expected: ${result.expectedAgent || 'Unknown'} | Actual: ${result.actualAgent || 'Unknown'}">
                            ${routingText}
                        </span>
                    </td>
                    <td>${result.duration}ms</td>
                    <td><button class="btn" onclick="showDetail(${result.questionNum})">View</button></td>
                    <td>
                        <span class="grade-badge ${gradeClass}">
                            ${result.grade} (${result.score.toFixed(0)}%)
                            <div class="grade-tooltip">${tooltipContent}</div>
                        </span>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function truncate(str, length) {
            return str && str.length > length ? str.substring(0, length) + '...' : str;
        }
        
        function showDetail(questionNum) {
            const result = allResults.find(r => r.questionNum === questionNum);
            if (!result) return;
            
            const gradeClass = `grade-${result.grade}`;
            
            // Render response as Markdown if marked.js is available
            let responseHtml = result.response || result.error || 'No response';
            if (typeof marked !== 'undefined' && result.response) {
                try {
                    responseHtml = marked.parse(result.response);
                } catch (e) {
                    // Fallback to plain text if parsing fails
                    responseHtml = `<pre style="white-space: pre-wrap;">${responseHtml}</pre>`;
                }
            } else {
                responseHtml = `<pre style="white-space: pre-wrap;">${responseHtml}</pre>`;
            }
            
            const content = `
                <h2>Question #${result.questionNum}</h2>
                <p><strong>Category:</strong> ${result.category}</p>
                ${result.agent ? `<p><strong>Expected Agent:</strong> ${result.agent}</p>` : ''}
                <p><strong>Grade:</strong> <span class="grade-badge ${gradeClass}">${result.grade} (${result.score.toFixed(1)}%)</span></p>
                <p><strong>Duration:</strong> ${result.duration}ms</p>
                <hr style="margin: 20px 0;">
                <h3>Question</h3>
                <p>${result.question}</p>
                <hr style="margin: 20px 0;">
                <h3>Response</h3>
                <div style="line-height: 1.6;">${responseHtml}</div>
                ${result.grading ? `
                    <hr style="margin: 20px 0;">
                    <h3>Grading Details</h3>
                    <ul>
                        ${Object.entries(result.grading).map(([key, value]) => 
                            `<li><strong>${key}:</strong> ${value}</li>`
                        ).join('')}
                    </ul>
                ` : ''}
                ${result.expectedKeywords && result.expectedKeywords.length > 0 ? `
                    <hr style="margin: 20px 0;">
                    <h3>Expected Keywords</h3>
                    <p>${result.expectedKeywords.join(', ')}</p>
                ` : ''}
            `;
            
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }
        
        function applyFilters() {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            currentResults = allResults.filter(r => {
                if (gradeFilter !== 'all' && r.grade !== gradeFilter) return false;
                if (categoryFilter !== 'all' && r.category !== categoryFilter) return false;
                if (searchText && !r.question.toLowerCase().includes(searchText)) return false;
                return true;
            });
            
            renderTable();
        }
        
        function exportResults() {
            let csv = 'Number,Category,Question,Response,Duration,Grade,Score\n';
            currentResults.forEach(r => {
                const response = (r.response || r.error || '').replace(/"/g, '""');
                csv += `${r.questionNum},"${r.category}","${r.question}","${response}",${r.duration},"${r.grade}",${r.score}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'baseline-results-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }
        
        function refreshData() {
            location.reload();
        }
        
        // Event listeners
        document.getElementById('gradeFilter').addEventListener('change', applyFilters);
        document.getElementById('categoryFilter').addEventListener('change', applyFilters);
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        
        // Close modal on background click
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // Load results on page load
        loadResults();
        
        // Editable functionality
        function initializeEditableElements() {
            document.addEventListener('click', function(e) {
                if (e.target.closest('.editable')) {
                    const editable = e.target.closest('.editable');
                    if (!editable.classList.contains('editing')) {
                        startEdit(editable);
                    }
                }
            });
        }
        
        function startEdit(element) {
            const field = element.dataset.field;
            const questionId = element.dataset.questionId;
            const originalValue = element.dataset.originalValue;
            
            element.classList.add('editing');
            
            let inputElement;
            if (field === 'question') {
                inputElement = document.createElement('textarea');
                inputElement.className = 'edit-textarea';
                inputElement.value = originalValue;
            } else {
                inputElement = document.createElement('input');
                inputElement.className = 'edit-input';
                inputElement.value = originalValue;
            }
            
            const controls = document.createElement('div');
            controls.className = 'edit-controls';
            controls.innerHTML = `
                <button class="edit-btn edit-save" onclick="saveEdit(this)">Save</button>
                <button class="edit-btn edit-cancel" onclick="cancelEdit(this)">Cancel</button>
            `;
            
            element.innerHTML = '';
            element.appendChild(inputElement);
            element.appendChild(controls);
            
            inputElement.focus();
            inputElement.select();
        }
        
        function saveEdit(button) {
            const editable = button.closest('.editable');
            const input = editable.querySelector('.edit-input, .edit-textarea');
            const field = editable.dataset.field;
            const questionId = editable.dataset.questionId;
            const newValue = input.value.trim();
            
            if (newValue === '') {
                alert('Value cannot be empty');
                return;
            }
            
            // Show loading state
            button.textContent = 'Saving...';
            button.disabled = true;
            
            // Create GitHub issue for the edit
            createGitHubIssue(questionId, field, editable.dataset.originalValue, newValue)
                .then(() => {
                    // Update the display
                    editable.classList.remove('editing');
                    editable.innerHTML = `${newValue}<span class="edit-icon">✏️</span>`;
                    editable.dataset.originalValue = newValue;
                    
                    // Update the result in memory
                    const result = allResults.find(r => r.id === questionId);
                    if (result) {
                        if (field === 'expectedKeywords') {
                            result.expectedKeywords = newValue.split(',').map(k => k.trim());
                        } else {
                            result[field] = newValue;
                        }
                    }
                    
                    showNotification('Edit saved and GitHub issue created!', 'success');
                })
                .catch(error => {
                    console.error('Error saving edit:', error);
                    button.textContent = 'Save';
                    button.disabled = false;
                    showNotification('Error saving edit: ' + error.message, 'error');
                });
        }
        
        function cancelEdit(button) {
            const editable = button.closest('.editable');
            const originalValue = editable.dataset.originalValue;
            
            editable.classList.remove('editing');
            editable.innerHTML = `${originalValue}<span class="edit-icon">✏️</span>`;
        }
        
        async function createGitHubIssue(questionId, field, oldValue, newValue) {
            const result = allResults.find(r => r.id === questionId);
            if (!result) {
                throw new Error('Question not found');
            }
            
            const agentName = result.expectedAgent || result.agent || 'unknown';
            const title = `📝 Edit ${field} for question: ${result.question.substring(0, 60)}...`;
            
            const body = `## 📝 Baseline Question Edit Request

**Question ID:** ${questionId}
**Agent:** ${agentName}
**Field:** ${field}
**Category:** ${result.category}

### Current Value:
\`\`\`
${oldValue}
\`\`\`

### Proposed New Value:
\`\`\`
${newValue}
\`\`\`

### Question:
${result.question}

### Context:
This edit was requested through the baseline test dashboard. Please review and update the corresponding agent's baseline.json file.

### Action Required:
1. Update the \`${field}\` field in the agent's baseline.json file
2. Re-run baseline tests to verify the change
3. Close this issue once the change is implemented

---
*This issue was automatically created from the baseline test dashboard.*`;

            // Get GitHub token
            const token = getGitHubToken();
            if (!token) {
                throw new Error('GitHub token is required to create issues');
            }

            // Use GitHub REST API directly
            const response = await fetch('https://api.github.com/repos/F8ai/formul8-multiagent/issues', {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    title,
                    body,
                    labels: ['baseline-edit', 'agent-' + agentName, 'automated']
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Failed to create GitHub issue: ${errorData.message || response.statusText}`);
            }
            
            const issueData = await response.json();
            return {
                success: true,
                issue: {
                    number: issueData.number,
                    url: issueData.html_url,
                    title: issueData.title
                }
            };
        }
        
        function showNotification(message, type = 'info') {
            // Create a simple notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            if (type === 'success') {
                notification.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#dc3545';
            } else {
                notification.style.backgroundColor = '#17a2b8';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Initialize editable functionality when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditableElements();
            loadGitHubToken();
            
            // Add event listeners for token modal
            document.getElementById('githubTokenInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveToken();
                }
            });
            
            // Close token modal on background click
            document.getElementById('tokenInputModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    cancelTokenInput();
                }
            });
        });
    </script>
</body>
</html>

