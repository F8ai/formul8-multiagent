<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul8 Plans Configuration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --formul8-primary: #00ff88;
            --formul8-secondary: #00d4aa;
            --formul8-accent: #ff6b35;
            --formul8-bg-primary: #0a0a0a;
            --formul8-bg-secondary: #1a1a1a;
            --formul8-bg-card: #1e1e1e;
            --formul8-bg-surface: #2a2a2a;
            --formul8-text-primary: #ffffff;
            --formul8-text-secondary: #b0b0b0;
            --formul8-text-muted: #888888;
            --formul8-border: #333333;
            --formul8-border-light: #444444;
            --formul8-glow: rgba(0, 255, 136, 0.3);
            --formul8-glow-secondary: rgba(0, 212, 170, 0.2);
            --formul8-glow-accent: rgba(255, 107, 53, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--formul8-bg-primary);
            background-image: 
                radial-gradient(circle at 20% 80%, var(--formul8-glow) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--formul8-glow-secondary) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--formul8-glow-accent) 0%, transparent 50%),
                linear-gradient(135deg, var(--formul8-bg-primary) 0%, var(--formul8-bg-secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--formul8-text-primary);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 30%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 170, 0.05) 0%, transparent 30%),
                radial-gradient(circle at 50% 50%, rgba(255, 107, 53, 0.03) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--formul8-bg-card);
            border-radius: 16px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.4),
                0 0 0 1px var(--formul8-border),
                0 0 20px rgba(0, 255, 136, 0.1),
                inset 0 1px 0 rgba(255,255,255,0.05);
            overflow: hidden;
            border: 1px solid var(--formul8-border);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--formul8-primary), transparent);
            opacity: 0.5;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .plans-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .plans-table th {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .plans-table th:first-child {
            text-align: left;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-width: 200px;
        }

        .plans-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid var(--formul8-border);
            vertical-align: middle;
        }

        .plans-table td:first-child {
            text-align: left;
        }

        .plans-table tr:hover {
            background-color: #f8f9fa;
        }

        .agent-name {
            font-weight: 600;
            color: var(--formul8-text-primary);
            text-align: left;
            padding-left: 0;
        }

        .agent-name.main-agent {
            font-weight: 700;
            color: var(--formul8-primary);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .agent-name.sub-agent {
            padding-left: 24px;
            font-weight: 500;
            color: var(--formul8-text-secondary);
            font-size: 0.95rem;
            position: relative;
        }

        .agent-name.sub-agent::before {
            content: '└─';
            position: absolute;
            left: 8px;
            color: var(--formul8-border-light);
            font-size: 0.8rem;
        }

        .agent-name.beta-agent {
            padding-left: 24px;
            font-weight: 500;
            color: var(--formul8-accent);
            font-size: 0.95rem;
            position: relative;
            font-style: italic;
        }

        .agent-name.beta-agent::before {
            content: 'β';
            position: absolute;
            left: 8px;
            color: var(--formul8-accent);
            font-size: 0.8rem;
            font-weight: bold;
            font-style: normal;
        }

        .agent-name.beta-agent::after {
            content: ' (Beta)';
            color: var(--formul8-text-muted);
            font-size: 0.8rem;
            font-weight: normal;
        }

        .plan-header {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .plan-header:hover {
            background-color: #f8f9fa;
        }

        .plan-header.editing {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 5px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .plan-price:hover {
            background-color: #f8f9fa;
        }

        .plan-price.editing {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .plan-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .plan-description:hover {
            background-color: #f8f9fa;
        }

        .plan-description.editing {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .editable-input {
            background: transparent;
            border: none;
            outline: none;
            font: inherit;
            color: inherit;
            width: 100%;
            padding: 0;
            margin: 0;
        }

        .editable-input:focus {
            background: white;
            border: 1px solid #2196f3;
            border-radius: 3px;
            padding: 2px 4px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #3498db;
        }

        .checkbox:checked {
            background-color: #3498db;
        }

        .controls {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .agent-category {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .plan-popular {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .plan-popular .plan-price,
        .plan-popular .plan-description {
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .plans-table {
                font-size: 0.8rem;
            }
            
            .plans-table th,
            .plans-table td {
                padding: 8px 4px;
            }
            
            .plans-table td:first-child {
                text-align: left;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Formul8 Plans Configuration</h1>
            <p>Configure which agents are available for each pricing plan</p>
        </div>
        
        <div class="content">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading configuration...</p>
            </div>
            
            <div id="status"></div>
            
            <table class="plans-table" id="plansTable">
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th class="plan-popular">
                            <div class="plan-header" onclick="startEditing('standard', 'name')" data-plan="standard" data-field="name">Standard</div>
                            <div class="plan-price" onclick="startEditing('standard', 'price')" data-plan="standard" data-field="price">$20/month</div>
                            <div class="plan-description" onclick="startEditing('standard', 'description')" data-plan="standard" data-field="description">Perfect for Artesians</div>
                        </th>
                        <th>
                            <div class="plan-header" onclick="startEditing('micro', 'name')" data-plan="micro" data-field="name">Micro</div>
                            <div class="plan-price" onclick="startEditing('micro', 'price')" data-plan="micro" data-field="price">$99/month</div>
                            <div class="plan-description" onclick="startEditing('micro', 'description')" data-plan="micro" data-field="description">Micro & Social Equity</div>
                        </th>
                        <th>
                            <div class="plan-header" onclick="startEditing('operator', 'name')" data-plan="operator" data-field="name">Operator</div>
                            <div class="plan-price" onclick="startEditing('operator', 'price')" data-plan="operator" data-field="price">$499/month</div>
                            <div class="plan-description" onclick="startEditing('operator', 'description')" data-plan="operator" data-field="description">Growing Businesses</div>
                        </th>
                        <th>
                            <div class="plan-header" onclick="startEditing('enterprise', 'name')" data-plan="enterprise" data-field="name">Enterprise</div>
                            <div class="plan-price" onclick="startEditing('enterprise', 'price')" data-plan="enterprise" data-field="price">Custom</div>
                            <div class="plan-description" onclick="startEditing('enterprise', 'description')" data-plan="enterprise" data-field="description">Large Operations</div>
                        </th>
                    </tr>
                </thead>
                <tbody id="plansTableBody">
                    <!-- Table will be populated by JavaScript -->
                </tbody>
            </table>
            
            <div class="controls">
                <button class="btn btn-primary" onclick="saveConfiguration()">Save Changes</button>
                <button class="btn btn-secondary" onclick="resetConfiguration()">Reset</button>
                <button class="btn btn-success" onclick="createPullRequest()">Create Pull Request</button>
            </div>
        </div>
    </div>

    <script>
        let plansConfig = null;
        let agentsConfig = null;
        let originalConfig = null;

        // Default configuration fallback
        const defaultPlansConfig = {
            "plans": {
                "standard": {
                    "name": "Standard",
                    "description": "Perfect for Artesians",
                    "price": "$20",
                    "period": "month",
                    "features": [
                        "Standard formulation tools",
                        "Future4200 Search and Summarize",
                        "calculations",
                        "Basic SOP starter templates",
                        "Science"
                    ],
                    "agents": {
                        "f8_agent": true,
                        "formulation": true,
                        "science": true
                    }
                },
                "micro": {
                    "name": "Micro",
                    "description": "Designed for micro and social equity licenses",
                    "price": "$99",
                    "period": "month",
                    "features": [
                        "Enhanced single state compliance checking",
                        "Everything in Standard",
                        "Advanced formulation tools",
                        "Single state marketing data",
                        "Compliant SOP templates",
                        "Scenario Mapping",
                        "Metrc API"
                    ],
                    "agents": {
                        "f8_agent": true,
                        "compliance": true,
                        "formulation": true,
                        "science": true,
                        "marketing": true,
                        "operations": true
                    }
                },
                "operator": {
                    "name": "Operator",
                    "description": "Ideal for growing cannabis businesses",
                    "price": "$499",
                    "period": "month",
                    "features": [
                        "Live 50 state compliance monitoring",
                        "Full formulation suite",
                        "Priority support",
                        "Unlimited calculations",
                        "Custom SOP generation",
                        "Extraction optimization",
                        "Document Upload and Storage (Coming soon)",
                        "Google Drive integration (Coming soon)",
                        "Marketing Strategy",
                        "Manuals/Troubleshooting",
                        "FTO Search"
                    ],
                    "agents": {
                        "f8_agent": true,
                        "compliance": true,
                        "formulation": true,
                        "science": true,
                        "operations": true,
                        "marketing": true,
                        "sourcing": true,
                        "patent": true,
                        "spectra": true,
                        "customer_success": true,
                        "f8_slackbot": true
                    }
                },
                "enterprise": {
                    "name": "Enterprise",
                    "description": "For large operations and multi-state businesses",
                    "price": "Custom",
                    "period": "",
                    "features": [
                        "Everything in Operator",
                        "Customer Service agents",
                        "White-label solutions",
                        "Dedicated account manager",
                        "Custom Workflow integrations",
                        "Advanced analytics",
                        "Multi-user management",
                        "API access",
                        "Custom training",
                        "SLA guarantees",
                        "Admin tools (Editor & Ad agents)"
                    ],
                    "agents": {
                        "f8_agent": true,
                        "compliance": true,
                        "formulation": true,
                        "science": true,
                        "operations": true,
                        "marketing": true,
                        "sourcing": true,
                        "patent": true,
                        "spectra": true,
                        "customer_success": true,
                        "f8_slackbot": true,
                        "mcr": true,
                        "ad": true,
                        "editor_agent": true
                    }
                }
            }
        };

        const defaultAgentsConfig = {
            "agents": {
                "f8_agent": {
                    "name": "F8 Multi-Agent",
                    "description": "Main Formul8 AI agent that can route to specialized agents",
                    "type": "main",
                    "url": "https://f8.syzygyx.com",
                    "keywords": ["general", "business", "strategy", "overview", "help"],
                    "specialties": [
                        "General cannabis industry questions",
                        "Business strategy and planning",
                        "Multi-topic queries",
                        "Agent routing and coordination"
                    ]
                },
                "compliance": {
                    "name": "Compliance Agent",
                    "description": "Cannabis regulatory compliance expert",
                    "type": "microservice",
                    "url": "https://compliance-agent.f8.syzygyx.com",
                    "keywords": ["compliance", "regulation", "license", "legal", "audit", "inspection", "permit", "regulatory"],
                    "specialties": [
                        "State and federal compliance",
                        "License management",
                        "Regulatory updates",
                        "Audit preparation"
                    ]
                },
                "formulation": {
                    "name": "Formulation Agent",
                    "description": "Cannabis product formulation specialist",
                    "type": "microservice",
                    "url": "https://formulation-agent.f8.syzygyx.com",
                    "keywords": ["formulation", "recipe", "dosage", "extraction", "ingredient", "thc", "cbd", "concentrate", "edible", "tincture"],
                    "specialties": [
                        "Product formulation",
                        "Dosage calculations",
                        "Extraction methods",
                        "Ingredient optimization"
                    ]
                },
                "science": {
                    "name": "Science Agent",
                    "description": "Cannabis research and scientific analysis expert",
                    "type": "microservice",
                    "url": "https://science-agent.f8.syzygyx.com",
                    "keywords": ["science", "research", "cannabinoid", "terpene", "lab", "testing", "coa", "analysis", "study", "clinical"],
                    "specialties": [
                        "Cannabinoid analysis",
                        "Terpene profiling",
                        "Lab testing interpretation",
                        "Scientific research"
                    ]
                },
                "operations": {
                    "name": "Operations Agent",
                    "description": "Cannabis facility operations and management expert",
                    "type": "microservice",
                    "url": "https://operations-agent.f8.syzygyx.com",
                    "keywords": ["operations", "facility", "management", "production", "quality", "control", "logistics", "manufacturing"],
                    "specialties": [
                        "Facility management",
                        "Production optimization",
                        "Quality control",
                        "Operational efficiency"
                    ]
                },
                "marketing": {
                    "name": "Marketing Agent",
                    "description": "Cannabis marketing and brand strategy specialist",
                    "type": "microservice",
                    "url": "https://marketing-agent.f8.syzygyx.com",
                    "keywords": ["marketing", "brand", "advertising", "promotion", "customer", "acquisition", "strategy", "campaign"],
                    "specialties": [
                        "Brand strategy",
                        "Digital marketing",
                        "Customer acquisition",
                        "Campaign development"
                    ]
                },
                "sourcing": {
                    "name": "Sourcing Agent",
                    "description": "Cannabis supply chain and procurement expert",
                    "type": "microservice",
                    "url": "https://sourcing-agent.f8.syzygyx.com",
                    "keywords": ["sourcing", "supply", "chain", "procurement", "vendor", "inventory", "supplier", "purchasing"],
                    "specialties": [
                        "Supplier management",
                        "Supply chain optimization",
                        "Vendor relations",
                        "Inventory management"
                    ]
                },
                "patent": {
                    "name": "Patent Agent",
                    "description": "Cannabis intellectual property and patent research specialist",
                    "type": "microservice",
                    "url": "https://patent-agent.f8.syzygyx.com",
                    "keywords": ["patent", "intellectual", "property", "ip", "research", "legal", "innovation", "invention"],
                    "specialties": [
                        "Patent research",
                        "IP strategy",
                        "Innovation analysis",
                        "Legal compliance"
                    ]
                },
                "spectra": {
                    "name": "Spectra Agent",
                    "description": "Cannabis spectral analysis and testing expert",
                    "type": "microservice",
                    "url": "https://spectra-agent.f8.syzygyx.com",
                    "keywords": ["spectra", "analysis", "testing", "lab", "equipment", "chemistry", "spectroscopy", "quality"],
                    "specialties": [
                        "Spectral analysis",
                        "Lab equipment guidance",
                        "Quality testing",
                        "Chemical analysis"
                    ]
                },
                "customer_success": {
                    "name": "Customer Success Agent",
                    "description": "Customer success and retention specialist",
                    "type": "microservice",
                    "url": "https://customer-success-agent.f8.syzygyx.com",
                    "keywords": ["customer", "success", "retention", "support", "satisfaction", "onboarding", "service"],
                    "specialties": [
                        "Customer onboarding",
                        "Retention strategies",
                        "Support optimization",
                        "Success metrics"
                    ]
                },
                "f8_slackbot": {
                    "name": "F8 Slackbot",
                    "description": "Slack integration and team collaboration agent",
                    "type": "microservice",
                    "url": "https://f8-slackbot.f8.syzygyx.com",
                    "keywords": ["slack", "integration", "team", "collaboration", "notification", "workflow", "communication"],
                    "specialties": [
                        "Slack integration",
                        "Team notifications",
                        "Workflow automation",
                        "Communication tools"
                    ]
                },
                "mcr": {
                    "name": "MCR Agent",
                    "description": "Master Control Record management specialist",
                    "type": "microservice",
                    "url": "https://mcr-agent.f8.syzygyx.com",
                    "keywords": ["mcr", "master", "control", "record", "documentation", "compliance", "tracking"],
                    "specialties": [
                        "MCR management",
                        "Documentation tracking",
                        "Compliance records",
                        "Control systems"
                    ]
                },
                "ad": {
                    "name": "Ad Agent",
                    "description": "Advertising and promotional content specialist",
                    "type": "microservice",
                    "url": "https://ad-agent.f8.syzygyx.com",
                    "keywords": ["advertising", "ad", "promotional", "campaign", "media", "strategy", "creative", "content"],
                    "specialties": [
                        "Ad campaign development",
                        "Creative content",
                        "Media strategy",
                        "Promotional planning"
                    ]
                },
                "editor_agent": {
                    "name": "Editor Agent",
                    "description": "Content editing and document management specialist",
                    "type": "microservice",
                    "url": "https://editor-agent.f8.syzygyx.com",
                    "keywords": ["edit", "editor", "content", "document", "review", "modify", "update", "version"],
                    "specialties": [
                        "Content editing",
                        "Document management",
                        "Version control",
                        "Review processes"
                    ]
                }
            }
        };

        // Load configurations
        async function loadConfigurations() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                // Try to load plans configuration from GitHub raw
                try {
                    const plansResponse = await fetch('https://raw.githubusercontent.com/F8ai/formul8-multiagent/main/config/plans.json');
                    if (plansResponse.ok) {
                        plansConfig = await plansResponse.json();
                        originalConfig = JSON.parse(JSON.stringify(plansConfig));
                        console.log('Plans config loaded from GitHub');
                    } else {
                        throw new Error('GitHub fetch failed');
                    }
                } catch (error) {
                    console.warn('Failed to load from GitHub, using default config:', error);
                    plansConfig = JSON.parse(JSON.stringify(defaultPlansConfig));
                    originalConfig = JSON.parse(JSON.stringify(plansConfig));
                }
                
                // Try to load agents configuration from GitHub raw
                try {
                    const agentsResponse = await fetch('https://raw.githubusercontent.com/F8ai/formul8-multiagent/main/config/agents.json');
                    if (agentsResponse.ok) {
                        agentsConfig = await agentsResponse.json();
                        console.log('Agents config loaded from GitHub');
                    } else {
                        throw new Error('GitHub fetch failed');
                    }
                } catch (error) {
                    console.warn('Failed to load agents from GitHub, using default config:', error);
                    agentsConfig = JSON.parse(JSON.stringify(defaultAgentsConfig));
                }
                
                renderTable();
                document.getElementById('loading').style.display = 'none';
                showStatus('Configuration loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading configurations:', error);
                document.getElementById('loading').style.display = 'none';
                showStatus('Error loading configuration: ' + error.message, 'error');
            }
        }

        // Render the plans table
        function renderTable() {
            const tbody = document.getElementById('plansTableBody');
            tbody.innerHTML = '';
            
            const planKeys = ['standard', 'micro', 'operator', 'enterprise'];
            
            // Organize agents hierarchically
            const agentHierarchy = {
                main: ['f8_agent'],
                sub: [
                    'compliance',
                    'operations', 
                    'marketing',
                    'formulation',
                    'patent',
                    'sourcing',
                    'customer_success',
                    'f8_slackbot',
                    'mcr',
                    'ad',
                    'editor_agent'
                ],
                beta: [
                    'science',
                    'spectra'
                ]
            };
            
            // Add main agent (F8)
            agentHierarchy.main.forEach(agentKey => {
                if (agentsConfig.agents[agentKey]) {
                    const agent = agentsConfig.agents[agentKey];
                    const row = document.createElement('tr');
                    
                    let rowHTML = `<td class="agent-name main-agent">${agent.name}</td>`;
                    
                    planKeys.forEach(planKey => {
                        const isChecked = plansConfig.plans[planKey].agents[agentKey] || false;
                        rowHTML += `
                            <td>
                                <input type="checkbox" 
                                       class="checkbox" 
                                       ${isChecked ? 'checked' : ''} 
                                       onchange="updatePlanAgent('${planKey}', '${agentKey}', this.checked)">
                            </td>
                        `;
                    });
                    
                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                }
            });
            
            // Add sub agents (indented)
            agentHierarchy.sub.forEach(agentKey => {
                if (agentsConfig.agents[agentKey]) {
                    const agent = agentsConfig.agents[agentKey];
                    const row = document.createElement('tr');
                    
                    let rowHTML = `<td class="agent-name sub-agent">${agent.name}</td>`;
                    
                    planKeys.forEach(planKey => {
                        const isChecked = plansConfig.plans[planKey].agents[agentKey] || false;
                        rowHTML += `
                            <td>
                                <input type="checkbox" 
                                       class="checkbox" 
                                       ${isChecked ? 'checked' : ''} 
                                       onchange="updatePlanAgent('${planKey}', '${agentKey}', this.checked)">
                            </td>
                        `;
                    });
                    
                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                }
            });
            
            // Add beta agents (indented with beta styling)
            agentHierarchy.beta.forEach(agentKey => {
                if (agentsConfig.agents[agentKey]) {
                    const agent = agentsConfig.agents[agentKey];
                    const row = document.createElement('tr');
                    
                    let rowHTML = `<td class="agent-name beta-agent">${agent.name}</td>`;
                    
                    planKeys.forEach(planKey => {
                        const isChecked = plansConfig.plans[planKey].agents[agentKey] || false;
                        rowHTML += `
                            <td>
                                <input type="checkbox" 
                                       class="checkbox" 
                                       ${isChecked ? 'checked' : ''} 
                                       onchange="updatePlanAgent('${planKey}', '${agentKey}', this.checked)">
                            </td>
                        `;
                    });
                    
                    row.innerHTML = rowHTML;
                    tbody.appendChild(row);
                }
            });
        }

        // Update plan-agent relationship
        function updatePlanAgent(planKey, agentKey, enabled) {
            if (!plansConfig.plans[planKey].agents) {
                plansConfig.plans[planKey].agents = {};
            }
            plansConfig.plans[planKey].agents[agentKey] = enabled;
        }

        // Save configuration
        async function saveConfiguration() {
            try {
                showStatus('Preparing pull request...', 'info');
                
                // Generate a unique branch name
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const branchName = `update-plans-config-${timestamp}`;
                
                // Create the updated plans.json content
                const plansJson = JSON.stringify(plansConfig, null, 2);
                
                // Create GitHub web editor URL for creating a new file
                const githubWebEditorUrl = `https://github.com/F8ai/formul8-multiagent/new/${branchName}?filename=config/plans.json&value=${encodeURIComponent(plansJson)}`;
                
                // Create PR creation URL
                const prCreateUrl = `https://github.com/F8ai/formul8-multiagent/compare/main...${branchName}`;
                
                showStatus('✅ Configuration prepared! Opening GitHub editor...', 'success');
                
                const prInfo = `
                    <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745;">
                        <h4>🎉 Ready to Create Pull Request!</h4>
                        <p>Follow these steps to create your PR:</p>
                        <ol>
                            <li><strong>Create Branch & File:</strong> <a href="${githubWebEditorUrl}" target="_blank" style="color: #007bff; text-decoration: underline;">Open GitHub Editor</a></li>
                            <li><strong>Commit the file</strong> with message: <code>Update plans configuration</code></li>
                            <li><strong>Create PR:</strong> <a href="${prCreateUrl}" target="_blank" style="color: #007bff; text-decoration: underline;">Create Pull Request</a></li>
                        </ol>
                        <p><strong>Branch Name:</strong> <code>${branchName}</code></p>
                        <p><strong>Files to Update:</strong></p>
                        <ul>
                            <li><code>config/plans.json</code> (main file)</li>
                            <li><code>config/langchain-{plan}.json</code> (run sync script after PR is created)</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <strong>After creating the PR, run this command to sync langchain files:</strong><br>
                            <code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">node scripts/sync-plans-to-langchain.js</code>
                        </div>
                    </div>
                `;
                
                document.getElementById('status').innerHTML += prInfo;
                
                // Auto-open the GitHub editor
                window.open(githubWebEditorUrl, '_blank');
                
                originalConfig = JSON.parse(JSON.stringify(plansConfig));
            } catch (error) {
                console.error('Error preparing pull request:', error);
                showStatus('Error preparing pull request: ' + error.message, 'error');
            }
        }

        // Reset configuration
        function resetConfiguration() {
            if (confirm('Are you sure you want to reset all changes?')) {
                plansConfig = JSON.parse(JSON.stringify(originalConfig));
                renderTable();
                showStatus('Configuration reset to original state', 'info');
            }
        }

        // Create pull request
        async function createPullRequest() {
            try {
                showStatus('Creating pull request...', 'info');
                
                const response = await fetch('/api/plans/pr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'Update Plans Configuration',
                        description: 'Updated agent access for pricing plans',
                        changes: plansConfig
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus(`Pull request created: ${result.prUrl}`, 'success');
                } else {
                    throw new Error('Failed to create pull request');
                }
            } catch (error) {
                console.error('Error creating pull request:', error);
                showStatus('Error creating pull request: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Start editing a plan field
        function startEditing(planKey, field) {
            const element = document.querySelector(`[data-plan="${planKey}"][data-field="${field}"]`);
            if (!element || element.classList.contains('editing')) return;
            
            const currentValue = element.textContent;
            element.classList.add('editing');
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editable-input';
            input.value = currentValue;
            
            // Replace content with input
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            
            // Handle save on blur or enter
            const saveEdit = () => {
                const newValue = input.value.trim();
                if (newValue !== currentValue) {
                    updatePlanField(planKey, field, newValue);
                }
                element.textContent = newValue;
                element.classList.remove('editing');
            };
            
            // Handle cancel on escape
            const cancelEdit = () => {
                element.textContent = currentValue;
                element.classList.remove('editing');
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        // Update a plan field in the configuration
        function updatePlanField(planKey, field, value) {
            if (!plansConfig.plans[planKey]) {
                plansConfig.plans[planKey] = {};
            }
            
            if (field === 'name') {
                plansConfig.plans[planKey].name = value;
            } else if (field === 'price') {
                plansConfig.plans[planKey].price = value;
            } else if (field === 'description') {
                plansConfig.plans[planKey].description = value;
            }
            
            // Update the display
            const element = document.querySelector(`[data-plan="${planKey}"][data-field="${field}"]`);
            if (element) {
                element.textContent = value;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadConfigurations);
    </script>
</body>
</html><!-- Updated Sun Oct 12 10:36:29 EDT 2025 -->
