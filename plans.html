<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul8 Plans Configuration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --formul8-primary: #00ff88;
            --formul8-secondary: #00d4aa;
            --formul8-accent: #ff6b35;
            --formul8-bg-primary: #0a0a0a;
            --formul8-bg-secondary: #1a1a1a;
            --formul8-bg-card: #1e1e1e;
            --formul8-bg-surface: #2a2a2a;
            --formul8-text-primary: #ffffff;
            --formul8-text-secondary: #b0b0b0;
            --formul8-text-muted: #888888;
            --formul8-border: #333333;
            --formul8-border-light: #444444;
            --formul8-glow: rgba(0, 255, 136, 0.3);
            --formul8-glow-secondary: rgba(0, 212, 170, 0.2);
            --formul8-glow-accent: rgba(255, 107, 53, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--formul8-bg-primary);
            background-image: 
                radial-gradient(circle at 20% 80%, var(--formul8-glow) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, var(--formul8-glow-secondary) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, var(--formul8-glow-accent) 0%, transparent 50%),
                linear-gradient(135deg, var(--formul8-bg-primary) 0%, var(--formul8-bg-secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--formul8-text-primary);
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 136, 0.05) 0%, transparent 30%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 170, 0.05) 0%, transparent 30%),
                radial-gradient(circle at 50% 50%, rgba(255, 107, 53, 0.03) 0%, transparent 40%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--formul8-bg-card);
            border-radius: 16px;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.4),
                0 0 0 1px var(--formul8-border),
                0 0 20px rgba(0, 255, 136, 0.1),
                inset 0 1px 0 rgba(255,255,255,0.05);
            overflow: hidden;
            border: 1px solid var(--formul8-border);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--formul8-primary), transparent);
            opacity: 0.5;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header-text {
            text-align: left;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .content {
            padding: 30px;
        }

        .plans-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--formul8-bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--formul8-border);
        }

        .plans-table th {
            background: linear-gradient(135deg, var(--formul8-primary) 0%, var(--formul8-secondary) 100%);
            color: var(--formul8-bg-primary);
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 0.85rem;
            width: 120px;
            min-width: 100px;
            vertical-align: top;
        }

        .plans-table th:first-child {
            text-align: left;
            background: linear-gradient(135deg, var(--formul8-bg-surface) 0%, var(--formul8-bg-card) 100%);
            min-width: 250px;
            width: 250px;
            color: var(--formul8-text-primary);
        }

        .plans-table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid var(--formul8-border);
            vertical-align: middle;
            background: var(--formul8-bg-card);
            color: var(--formul8-text-primary);
        }

        .plans-table td:first-child {
            text-align: left;
        }

        .plans-table tr:hover td {
            background: var(--formul8-bg-surface);
        }

        .agent-name {
            font-weight: 600;
            color: var(--formul8-text-primary);
            text-align: left;
            padding: 12px 0;
            position: relative;
            font-size: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.4;
        }

        .agent-name.main-agent {
            font-weight: 700;
            color: var(--formul8-primary);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .agent-name.sub-agent {
            padding-left: 20px;
            font-weight: 500;
            color: var(--formul8-text-primary);
            font-size: 1rem;
            position: relative;
        }

        .agent-name.sub-agent::before {
            content: '';
        }

        .agent-name.beta-agent {
            padding-left: 20px;
            font-weight: 500;
            color: var(--formul8-text-primary);
            font-size: 1rem;
            position: relative;
            font-style: normal;
        }

        .agent-name.beta-agent::before {
            content: '';
        }

        .agent-name.beta-agent::after {
            content: '';
        }

        .agent-section-header {
            background: #2d3436;
            color: var(--formul8-text-primary);
            font-weight: 700;
            font-size: 1rem;
            padding: 12px 16px;
            text-align: center;
            border-bottom: 2px solid var(--formul8-border);
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .agent-row {
            cursor: move;
            transition: all 0.2s ease;
        }

        .agent-row:hover {
            background-color: var(--formul8-bg-surface);
        }

        .agent-row.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            background-color: var(--formul8-accent);
            color: var(--formul8-bg-primary);
        }

        .agent-row.drag-over {
            border-top: 2px solid var(--formul8-primary);
            background-color: var(--formul8-bg-surface);
        }

        .agent-row .drag-handle {
            cursor: grab;
            color: var(--formul8-text-muted);
            margin-right: 8px;
            font-size: 0.9rem;
        }

        .agent-row .drag-handle:active {
            cursor: grabbing;
        }

        .agent-row .drag-handle:hover {
            color: var(--formul8-primary);
        }

        .agent-features {
            margin-top: 6px;
            font-size: 0.65rem;
            line-height: 1.2;
        }

        .feature-bullet {
            color: var(--formul8-text-muted);
            margin-bottom: 1px;
            padding-left: 2px;
        }

        .plan-header {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            line-height: 1.2;
            margin-bottom: 8px;
        }

        .plan-header:hover {
            background-color: #f8f9fa;
        }

        .plan-header.editing {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            line-height: 1.2;
        }

        .plan-price:hover {
            background-color: #f8f9fa;
        }

        .plan-price.editing {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .plan-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            line-height: 1.3;
        }

        .plan-description:hover {
            background-color: #f8f9fa;
        }

        .plan-description.editing {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }

        .editable-input {
            background: transparent;
            border: none;
            outline: none;
            font: inherit;
            color: inherit;
            width: 100%;
            padding: 0;
            margin: 0;
        }

        .editable-input:focus {
            background: white;
            border: 1px solid #2196f3;
            border-radius: 3px;
            padding: 2px 4px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--formul8-primary);
        }

        .checkbox:checked {
            background-color: var(--formul8-primary);
        }


        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(149, 165, 166, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .agent-category {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .plan-popular {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .plan-popular .plan-price,
        .plan-popular .plan-description {
            color: white;
        }

        .plan-angled {
            position: relative;
            overflow: hidden;
        }

        .plan-angled::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--formul8-primary) 0%, var(--formul8-secondary) 100%);
            transform: skewY(-2deg);
            z-index: -1;
        }

        .plan-angled .plan-header,
        .plan-angled .plan-price,
        .plan-angled .plan-description {
            color: var(--formul8-bg-primary);
            font-weight: 600;
        }

        .plan-angled.free-plan::before {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
        }

        .plan-angled.beta-plan::before {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
        }

        .plan-angled.future4200-plan::before {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
        }

        .plan-angled.admin-plan::before {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 8px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-text {
                text-align: center;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .header-controls {
                justify-content: center;
            }
            
            .content {
                padding: 20px;
            }
            
            .plans-table {
                font-size: 0.8rem;
            }
            
            .plans-table th,
            .plans-table td {
                padding: 8px 4px;
            }
            
            .plans-table td:first-child {
                text-align: left;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>Formul8 Plans Configuration</h1>
                    <p>Configure which agents are available for each pricing plan</p>
                </div>
                <div class="header-controls">
                    <button class="btn btn-secondary" onclick="resetConfiguration()">Reset</button>
                    <button class="btn btn-primary" onclick="saveConfiguration()">Save & Create PR</button>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading configuration...</p>
            </div>
            
            <div id="status"></div>
            
            <table class="plans-table" id="plansTable">
                <thead>
                    <tr>
                        <th>Agent</th>
                        <th class="plan-angled free-plan">
                            <div class="plan-header" onclick="startEditing('free', 'name')" data-plan="free" data-field="name">Free</div>
                            <div class="plan-price" onclick="startEditing('free', 'price')" data-plan="free" data-field="price">$0/month</div>
                            <div class="plan-description" onclick="startEditing('free', 'description')" data-plan="free" data-field="description">Basic Access with Ads</div>
                        </th>
                        <th class="plan-popular">
                            <div class="plan-header" onclick="startEditing('standard', 'name')" data-plan="standard" data-field="name">Standard</div>
                            <div class="plan-price" onclick="startEditing('standard', 'price')" data-plan="standard" data-field="price">$20/month</div>
                            <div class="plan-description" onclick="startEditing('standard', 'description')" data-plan="standard" data-field="description">Perfect for Artesians</div>
                        </th>
                        <th>
                            <div class="plan-header" onclick="startEditing('micro', 'name')" data-plan="micro" data-field="name">Micro</div>
                            <div class="plan-price" onclick="startEditing('micro', 'price')" data-plan="micro" data-field="price">$99/month</div>
                            <div class="plan-description" onclick="startEditing('micro', 'description')" data-plan="micro" data-field="description">Micro & Social Equity</div>
                        </th>
                        <th>
                            <div class="plan-header" onclick="startEditing('operator', 'name')" data-plan="operator" data-field="name">Operator</div>
                            <div class="plan-price" onclick="startEditing('operator', 'price')" data-plan="operator" data-field="price">$499/month</div>
                            <div class="plan-description" onclick="startEditing('operator', 'description')" data-plan="operator" data-field="description">Growing Businesses</div>
                        </th>
                        <th>
                            <div class="plan-header" onclick="startEditing('enterprise', 'name')" data-plan="enterprise" data-field="name">Enterprise</div>
                            <div class="plan-price" onclick="startEditing('enterprise', 'price')" data-plan="enterprise" data-field="price">Custom</div>
                            <div class="plan-description" onclick="startEditing('enterprise', 'description')" data-plan="enterprise" data-field="description">Large Operations</div>
                        </th>
                        <th class="plan-angled beta-plan">
                            <div class="plan-header" onclick="startEditing('beta', 'name')" data-plan="beta" data-field="name">Beta</div>
                            <div class="plan-price" onclick="startEditing('beta', 'price')" data-plan="beta" data-field="price">N/A</div>
                            <div class="plan-description" onclick="startEditing('beta', 'description')" data-plan="beta" data-field="description">Experimental Features</div>
                        </th>
                        <th class="plan-angled admin-plan">
                            <div class="plan-header" onclick="startEditing('admin', 'name')" data-plan="admin" data-field="name">Admin</div>
                            <div class="plan-price" onclick="startEditing('admin', 'price')" data-plan="admin" data-field="price">N/A</div>
                            <div class="plan-description" onclick="startEditing('admin', 'description')" data-plan="admin" data-field="description">Full System Access</div>
                        </th>
                        <th class="plan-angled future4200-plan">
                            <div class="plan-header" onclick="startEditing('future4200', 'name')" data-plan="future4200" data-field="name">Future4200.com</div>
                            <div class="plan-price" onclick="startEditing('future4200', 'price')" data-plan="future4200" data-field="price">$29/month</div>
                            <div class="plan-description" onclick="startEditing('future4200', 'description')" data-plan="future4200" data-field="description">Community Access</div>
                        </th>
                    </tr>
                </thead>
                <tbody id="plansTableBody">
                    <!-- Table will be populated by JavaScript -->
                </tbody>
            </table>
            
        </div>
    </div>

    <script>
        let plansConfig = null;
        let agentsConfig = null;
        let originalConfig = null;

        // Default configuration fallback
        const defaultPlansConfig = {
            "plans": {
                "free": {
                    "name": "Free",
                    "description": "Basic access with ads",
                    "price": "$0",
                    "period": "/month",
                    "features": [
                        "Basic formulation tools",
                        "Limited compliance checking",
                        "Ad-supported experience",
                        "Community support"
                    ],
                    "agents": {
                        "compliance": true,
                        "formulation": true,
                        "ad": true,
                        "operations": false,
                        "marketing": false,
                        "patent": false,
                        "sourcing": false,
                        "customer_success": false,
                        "mcr": false,
                        "future4200": false,
                        "future": false,
                        "science": false,
                        "spectra": false,
                        "metabolome": false,
                        "f8_slackbot": false,
                        "editor_agent": false
                    }
                },
                "standard": {
                    "name": "Standard",
                    "description": "Perfect for Artesians",
                    "price": "$20",
                    "period": "/month",
                    "features": [
                        "Standard formulation tools",
                        "Future4200 Search and Summarize",
                        "calculations",
                        "Basic SOP starter templates",
                        "Science",
                        "Get Notified"
                    ],
                    "agents": {
                        "compliance": true,
                        "operations": true,
                        "marketing": true,
                        "formulation": true,
                        "patent": true,
                        "sourcing": true,
                        "customer_success": true,
                        "mcr": true,
                        "science": false,
                        "spectra": false,
                        "metabolome": false,
                        "f8_slackbot": false,
                        "ad": false,
                        "editor_agent": false
                    }
                },
                "micro": {
                    "name": "Micro",
                    "description": "Designed for micro and social equity licenses",
                    "price": "$99",
                    "period": "/month",
                    "features": [
                        "Enhanced single state compliance checking",
                        "Everything in Standard",
                        "Advanced formulation tools",
                        "Single state marketing data",
                        "Compliant SOP templates",
                        "Scenario Mapping",
                        "Metrc API",
                        "Get Notified"
                    ],
                    "agents": {
                        "compliance": true,
                        "operations": true,
                        "marketing": true,
                        "formulation": true,
                        "patent": true,
                        "sourcing": true,
                        "customer_success": true,
                        "mcr": true,
                        "science": false,
                        "spectra": false,
                        "metabolome": false,
                        "f8_slackbot": false,
                        "ad": false,
                        "editor_agent": false
                    }
                },
                "operator": {
                    "name": "Operator",
                    "description": "Ideal for growing cannabis businesses",
                    "price": "$499",
                    "period": "/month",
                    "features": [
                        "Live 50 state compliance monitoring",
                        "Full formulation suite",
                        "Priority support",
                        "Unlimited calculations",
                        "Custom SOP generation",
                        "Extraction optimization",
                        "Document Upload and Storage (Coming soon)",
                        "Google Drive integration (Coming soon)",
                        "Marketing Strategy",
                        "Manuals/Troubleshooting",
                        "FTO Search",
                        "Get Notified"
                    ],
                    "agents": {
                        "compliance": true,
                        "operations": true,
                        "marketing": true,
                        "formulation": true,
                        "patent": true,
                        "sourcing": true,
                        "customer_success": true,
                        "mcr": true,
                        "science": false,
                        "spectra": false,
                        "metabolome": false,
                        "f8_slackbot": false,
                        "ad": false,
                        "editor_agent": false
                    }
                },
                "enterprise": {
                    "name": "Enterprise",
                    "description": "For large operations and multi-state businesses",
                    "price": "Custom",
                    "period": "",
                    "features": [
                        "Everything in Operator",
                        "Customer Service agents",
                        "White-label solutions",
                        "Dedicated account manager",
                        "Custom Workflow integrations",
                        "Advanced analytics",
                        "Multi-user management",
                        "API access",
                        "Custom training",
                        "SLA guarantees",
                        "Get Notified"
                    ],
                    "agents": {
                        "compliance": true,
                        "operations": true,
                        "marketing": true,
                        "formulation": true,
                        "patent": true,
                        "sourcing": true,
                        "customer_success": true,
                        "mcr": true,
                        "science": false,
                        "spectra": false,
                        "metabolome": false,
                        "f8_slackbot": false,
                        "ad": false,
                        "editor_agent": false
                    }
                },
                "beta": {
                    "name": "Beta",
                    "description": "Access to experimental features",
                    "price": "N/A",
                    "period": "",
                    "features": [
                        "Everything in Standard",
                        "Beta agent access",
                        "Early feature preview",
                        "Direct feedback channel",
                        "Experimental tools"
                    ],
                    "agents": {
                        "compliance": true,
                        "operations": true,
                        "marketing": true,
                        "formulation": true,
                        "patent": true,
                        "sourcing": true,
                        "customer_success": true,
                        "mcr": true,
                        "science": true,
                        "spectra": true,
                        "metabolome": true,
                        "f8_slackbot": false,
                        "ad": false,
                        "editor_agent": false
                    }
                },
                "admin": {
                    "name": "Admin",
                    "description": "Full system access and admin tools",
                    "price": "N/A",
                    "period": "",
                    "features": [
                        "Everything in all plans",
                        "Admin tools access",
                        "System configuration",
                        "Advanced analytics",
                        "Custom integrations",
                        "Priority support"
                    ],
                    "agents": {
                        "compliance": true,
                        "operations": true,
                        "marketing": true,
                        "formulation": true,
                        "patent": true,
                        "sourcing": true,
                        "customer_success": true,
                        "mcr": true,
                        "future4200": true,
                        "future": true,
                        "science": true,
                        "spectra": true,
                        "metabolome": true,
                        "f8_slackbot": true,
                        "ad": false,
                        "editor_agent": true
                    }
                },
                "future4200": {
                    "name": "Future4200.com",
                    "description": "Community access plan",
                    "price": "$29",
                    "period": "/month",
                    "features": [
                        "Future4200 forum access",
                        "Community intelligence",
                        "Discussion analysis",
                        "Trend identification",
                        "Basic formulation tools"
                    ],
                    "agents": {
                        "compliance": false,
                        "operations": false,
                        "marketing": false,
                        "formulation": true,
                        "patent": false,
                        "sourcing": false,
                        "customer_success": false,
                        "mcr": false,
                        "future4200": true,
                        "future": false,
                        "science": false,
                        "spectra": false,
                        "metabolome": false,
                        "f8_slackbot": false,
                        "ad": false,
                        "editor_agent": false
                    }
                }
            }
        };

        const defaultAgentsConfig = {
            "agents": {
                "compliance": {
                    "name": "Compliance Agent",
                    "description": "Cannabis regulatory compliance expert",
                    "type": "microservice",
                    "url": "https://compliance-agent.f8.syzygyx.com",
                    "keywords": ["compliance", "regulation", "license", "legal", "audit", "inspection", "permit", "regulatory"],
                    "specialties": [
                        "State and federal compliance",
                        "License management",
                        "Regulatory updates",
                        "Audit preparation"
                    ]
                },
                "formulation": {
                    "name": "Formulation Agent",
                    "description": "Cannabis product formulation specialist",
                    "type": "microservice",
                    "url": "https://formulation-agent.f8.syzygyx.com",
                    "keywords": ["formulation", "recipe", "dosage", "extraction", "ingredient", "thc", "cbd", "concentrate", "edible", "tincture"],
                    "specialties": [
                        "Product formulation",
                        "Dosage calculations",
                        "Extraction methods",
                        "Ingredient optimization"
                    ]
                },
                "science": {
                    "name": "Science Agent",
                    "description": "Advanced cannabis research and scientific analysis expert",
                    "type": "microservice",
                    "url": "https://science-agent.f8.syzygyx.com",
                    "keywords": ["science", "research", "cannabinoid", "terpene", "lab", "testing", "coa", "analysis", "study", "clinical", "biochemistry", "pharmacology"],
                    "specialties": [
                        "Advanced cannabinoid analysis",
                        "Comprehensive terpene profiling",
                        "Lab testing interpretation and validation",
                        "Scientific research and clinical studies",
                        "Biochemical pathway analysis"
                    ]
                },
                "operations": {
                    "name": "Operations Agent",
                    "description": "Cannabis facility operations and management expert",
                    "type": "microservice",
                    "url": "https://operations-agent.f8.syzygyx.com",
                    "keywords": ["operations", "facility", "management", "production", "quality", "control", "logistics", "manufacturing"],
                    "specialties": [
                        "Facility management",
                        "Production optimization",
                        "Quality control",
                        "Operational efficiency"
                    ]
                },
                "marketing": {
                    "name": "Marketing Agent",
                    "description": "Cannabis marketing and brand strategy specialist",
                    "type": "microservice",
                    "url": "https://marketing-agent.f8.syzygyx.com",
                    "keywords": ["marketing", "brand", "advertising", "promotion", "customer", "acquisition", "strategy", "campaign"],
                    "specialties": [
                        "Brand strategy",
                        "Digital marketing",
                        "Customer acquisition",
                        "Campaign development"
                    ]
                },
                "sourcing": {
                    "name": "Sourcing Agent",
                    "description": "Cannabis supply chain and procurement expert",
                    "type": "microservice",
                    "url": "https://sourcing-agent.f8.syzygyx.com",
                    "keywords": ["sourcing", "supply", "chain", "procurement", "vendor", "inventory", "supplier", "purchasing"],
                    "specialties": [
                        "Supplier management",
                        "Supply chain optimization",
                        "Vendor relations",
                        "Inventory management"
                    ]
                },
                "patent": {
                    "name": "Patent Agent",
                    "description": "Cannabis intellectual property and patent research specialist",
                    "type": "microservice",
                    "url": "https://patent-agent.f8.syzygyx.com",
                    "keywords": ["patent", "intellectual", "property", "ip", "research", "legal", "innovation", "invention"],
                    "specialties": [
                        "Patent research",
                        "IP strategy",
                        "Innovation analysis",
                        "Legal compliance"
                    ]
                },
                "spectra": {
                    "name": "Spectra Agent",
                    "description": "Cannabis spectral analysis and testing expert",
                    "type": "microservice",
                    "url": "https://spectra-agent.f8.syzygyx.com",
                    "keywords": ["spectra", "analysis", "testing", "lab", "equipment", "chemistry", "spectroscopy", "quality"],
                    "specialties": [
                        "Spectral analysis",
                        "Lab equipment guidance",
                        "Quality testing",
                        "Chemical analysis"
                    ]
                },
                "metabolome": {
                    "name": "Metabolome Agent",
                    "description": "Cannabis metabolomics and biochemical analysis expert",
                    "type": "microservice",
                    "url": "https://metabolome-agent.f8.syzygyx.com",
                    "keywords": ["metabolome", "metabolomics", "biochemistry", "metabolites", "analysis", "profiling", "biomarkers"],
                    "specialties": [
                        "Metabolite profiling",
                        "Biochemical analysis",
                        "Metabolomics research",
                        "Biomarker identification"
                    ]
                },
                "customer_success": {
                    "name": "Customer Success Agent",
                    "description": "Customer success and retention specialist",
                    "type": "microservice",
                    "url": "https://customer-success-agent.f8.syzygyx.com",
                    "keywords": ["customer", "success", "retention", "support", "satisfaction", "onboarding", "service"],
                    "specialties": [
                        "Customer onboarding",
                        "Retention strategies",
                        "Support optimization",
                        "Success metrics"
                    ]
                },
                "f8_slackbot": {
                    "name": "F8 Slackbot",
                    "description": "Slack integration and team collaboration agent",
                    "type": "microservice",
                    "url": "https://f8-slackbot.f8.syzygyx.com",
                    "keywords": ["slack", "integration", "team", "collaboration", "notification", "workflow", "communication"],
                    "specialties": [
                        "Slack integration",
                        "Team notifications",
                        "Workflow automation",
                        "Communication tools"
                    ]
                },
                "mcr": {
                    "name": "MCR Agent",
                    "description": "Master Control Record management specialist",
                    "type": "microservice",
                    "url": "https://mcr-agent.f8.syzygyx.com",
                    "keywords": ["mcr", "master", "control", "record", "documentation", "compliance", "tracking"],
                    "specialties": [
                        "MCR management",
                        "Documentation tracking",
                        "Compliance records",
                        "Control systems"
                    ]
                },
                "future4200": {
                    "name": "Future4200 Agent",
                    "description": "Future4200 forum search and community intelligence specialist",
                    "type": "microservice",
                    "url": "https://future4200-agent.f8.syzygyx.com",
                    "keywords": ["future4200", "forum", "community", "search", "discussion", "threads", "posts"],
                    "specialties": [
                        "Forum search and analysis",
                        "Community intelligence",
                        "Discussion summarization",
                        "Trend identification"
                    ]
                },
                "future": {
                    "name": "Future Agent",
                    "description": "Future trends and innovation prediction specialist",
                    "type": "microservice",
                    "url": "https://future-agent.f8.syzygyx.com",
                    "keywords": ["future", "trends", "innovation", "prediction", "forecasting", "technology", "disruption"],
                    "specialties": [
                        "Trend analysis and forecasting",
                        "Innovation prediction",
                        "Technology disruption analysis",
                        "Future market insights"
                    ]
                },
                "ad": {
                    "name": "Ad Agent",
                    "description": "Advertising and promotional content specialist",
                    "type": "microservice",
                    "url": "https://ad-agent.f8.syzygyx.com",
                    "keywords": ["advertising", "ad", "promotional", "campaign", "media", "strategy", "creative", "content"],
                    "specialties": [
                        "Ad campaign development",
                        "Creative content",
                        "Media strategy",
                        "Promotional planning"
                    ]
                },
                "editor_agent": {
                    "name": "Editor Agent",
                    "description": "Content editing and document management specialist",
                    "type": "microservice",
                    "url": "https://editor-agent.f8.syzygyx.com",
                    "keywords": ["edit", "editor", "content", "document", "review", "modify", "update", "version"],
                    "specialties": [
                        "Content editing",
                        "Document management",
                        "Version control",
                        "Review processes"
                    ]
                }
            }
        };

        // Load configurations
        async function loadConfigurations() {
            try {
                document.getElementById('loading').style.display = 'block';
                
                // Try to load plans configuration from GitHub raw
                try {
                    const plansResponse = await fetch('https://raw.githubusercontent.com/F8ai/formul8-multiagent/main/config/plans.json');
                    if (plansResponse.ok) {
                        const plansData = await plansResponse.json();
                        if (plansData && plansData.plans) {
                            plansConfig = plansData;
                            originalConfig = JSON.parse(JSON.stringify(plansConfig));
                            console.log('Plans config loaded from GitHub');
                        } else {
                            throw new Error('Invalid plans configuration format');
                        }
                    } else {
                        throw new Error('GitHub fetch failed');
                    }
                } catch (error) {
                    console.warn('Failed to load from GitHub, using default config:', error);
                    plansConfig = JSON.parse(JSON.stringify(defaultPlansConfig));
                    originalConfig = JSON.parse(JSON.stringify(plansConfig));
                }
                
                // Try to load agents configuration from GitHub raw
                try {
                    const agentsResponse = await fetch('https://raw.githubusercontent.com/F8ai/formul8-multiagent/main/config/agents.json');
                    if (agentsResponse.ok) {
                        const agentsData = await agentsResponse.json();
                        if (agentsData && agentsData.agents) {
                            agentsConfig = agentsData;
                            console.log('Agents config loaded from GitHub');
                        } else {
                            throw new Error('Invalid agents configuration format');
                        }
                    } else {
                        throw new Error('GitHub fetch failed');
                    }
                } catch (error) {
                    console.warn('Failed to load agents from GitHub, using default config:', error);
                    agentsConfig = JSON.parse(JSON.stringify(defaultAgentsConfig));
                }
                
                // Ensure configurations are initialized
                if (!plansConfig) {
                    plansConfig = JSON.parse(JSON.stringify(defaultPlansConfig));
                    originalConfig = JSON.parse(JSON.stringify(plansConfig));
                }
                if (!agentsConfig) {
                    agentsConfig = JSON.parse(JSON.stringify(defaultAgentsConfig));
                }
                
                renderTable();
                document.getElementById('loading').style.display = 'none';
                showStatus('Configuration loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading configurations:', error);
                // Fallback to default configurations
                plansConfig = JSON.parse(JSON.stringify(defaultPlansConfig));
                agentsConfig = JSON.parse(JSON.stringify(defaultAgentsConfig));
                originalConfig = JSON.parse(JSON.stringify(plansConfig));
                
                renderTable();
                document.getElementById('loading').style.display = 'none';
                showStatus('Using default configuration due to error: ' + error.message, 'warning');
            }
        }

        // Render the plans table
        function renderTable() {
            const tbody = document.getElementById('plansTableBody');
            tbody.innerHTML = '';
            
            // Check if configurations are loaded
            if (!plansConfig || !agentsConfig) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--formul8-text-muted);">Loading configuration...</td></tr>';
                return;
            }
            
            const planKeys = ['free', 'standard', 'micro', 'operator', 'enterprise', 'beta', 'admin', 'future4200'];
            
            // Organize agents by sections
            const agentSections = {
                f8: {
                    title: 'F8 Core Agents',
                    agents: [
                        'compliance',
                        'operations', 
                        'marketing',
                        'formulation',
                        'patent',
                        'sourcing',
                        'customer_success'
                    ]
                },
                beta: {
                    title: 'Beta Features',
                    agents: [
                        'science',
                        'spectra',
                        'metabolome'
                    ]
                },
                free: {
                    title: 'Free Plan Features',
                    agents: [
                        'ad'
                    ]
                },
                custom: {
                    title: 'Custom Agents',
                    agents: [
                        'future4200',
                        'mcr'
                    ]
                },
                admin: {
                    title: 'Admin Tools',
                    agents: [
                        'f8_slackbot',
                        'editor_agent'
                    ]
                }
            };
            
            // Create sections
            Object.entries(agentSections).forEach(([sectionKey, section]) => {
                // Add section header
                const headerRow = document.createElement('tr');
                const headerCell = document.createElement('td');
                headerCell.className = `agent-section-header ${sectionKey}-section`;
                headerCell.colSpan = planKeys.length + 1; // +1 for agent name column
                headerCell.textContent = section.title;
                headerRow.appendChild(headerCell);
                tbody.appendChild(headerRow);
                
                // Add agents in this section
                section.agents.forEach(agentKey => {
                    if (agentsConfig.agents[agentKey]) {
                        const agent = agentsConfig.agents[agentKey];
                        const row = document.createElement('tr');
                        
                        // Determine agent styling based on section
                        let agentClass = 'agent-name';
                        if (sectionKey === 'beta') {
                            agentClass += ' beta-agent';
                        } else if (sectionKey === 'free') {
                            agentClass += ' sub-agent';
                        } else if (sectionKey === 'custom') {
                            agentClass += ' sub-agent';
                        } else if (sectionKey === 'admin') {
                            agentClass += ' sub-agent';
                        } else {
                            agentClass += ' sub-agent';
                        }
                        
                        let rowHTML = `<td class="${agentClass}"><span class="drag-handle">⋮⋮</span>${agent.name}</td>`;
                        
                        planKeys.forEach(planKey => {
                            const isChecked = (plansConfig.plans[planKey] && plansConfig.plans[planKey].agents && plansConfig.plans[planKey].agents[agentKey]) || false;
                            const planFeatures = plansConfig.plans[planKey] ? plansConfig.plans[planKey].features || [] : [];
                            const agentFeatures = planFeatures.filter(feature => 
                                feature.toLowerCase().includes(agent.name.toLowerCase().split(' ')[0]) ||
                                (agentKey === 'compliance' && feature.toLowerCase().includes('compliance')) ||
                                (agentKey === 'formulation' && feature.toLowerCase().includes('formulation')) ||
                                (agentKey === 'science' && feature.toLowerCase().includes('science')) ||
                                (agentKey === 'marketing' && feature.toLowerCase().includes('marketing')) ||
                                (agentKey === 'operations' && feature.toLowerCase().includes('operations')) ||
                                (agentKey === 'patent' && feature.toLowerCase().includes('patent')) ||
                                (agentKey === 'sourcing' && feature.toLowerCase().includes('sourcing')) ||
                                (agentKey === 'customer_success' && feature.toLowerCase().includes('customer')) ||
                                (agentKey === 'mcr' && feature.toLowerCase().includes('mcr')) ||
                                (agentKey === 'future4200' && feature.toLowerCase().includes('future4200')) ||
                                (agentKey === 'future' && feature.toLowerCase().includes('future')) ||
                                (agentKey === 'ad' && feature.toLowerCase().includes('ad')) ||
                                (agentKey === 'editor_agent' && feature.toLowerCase().includes('editor')) ||
                                (agentKey === 'f8_slackbot' && feature.toLowerCase().includes('slackbot')) ||
                                (agentKey === 'spectra' && feature.toLowerCase().includes('spectra')) ||
                                (agentKey === 'metabolome' && feature.toLowerCase().includes('metabolome'))
                            );
                            
                            rowHTML += `
                                <td>
                                    <input type="checkbox" 
                                           class="checkbox" 
                                           ${isChecked ? 'checked' : ''} 
                                           onchange="updatePlanAgent('${planKey}', '${agentKey}', this.checked)">
                                    ${agentFeatures.length > 0 ? `<div class="agent-features">${agentFeatures.map(feature => `<div class="feature-bullet">• ${feature}</div>`).join('')}</div>` : ''}
                                </td>
                            `;
                        });
                        
                        row.innerHTML = rowHTML;
                        row.className = 'agent-row';
                        row.draggable = true;
                        row.dataset.agentKey = agentKey;
                        row.dataset.sectionKey = sectionKey;
                        
                        // Add drag event listeners
                        row.addEventListener('dragstart', handleAgentDragStart);
                        row.addEventListener('dragend', handleAgentDragEnd);
                        row.addEventListener('dragover', handleAgentDragOver);
                        row.addEventListener('drop', handleAgentDrop);
                        
                        tbody.appendChild(row);
                    }
                });
            });
        }

        // Update plan-agent relationship
        function updatePlanAgent(planKey, agentKey, enabled) {
            if (!plansConfig || !plansConfig.plans || !plansConfig.plans[planKey]) {
                console.error('Plans configuration not loaded or invalid plan key:', planKey);
                return;
            }
            
            if (!plansConfig.plans[planKey].agents) {
                plansConfig.plans[planKey].agents = {};
            }
            plansConfig.plans[planKey].agents[agentKey] = enabled;
        }

        // Save configuration and create pull request
        async function saveConfiguration() {
            try {
                showStatus('Preparing pull request...', 'info');
                
                // Generate a unique branch name
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const branchName = `update-plans-config-${timestamp}`;
                
                // Create the updated plans.json content
                const plansJson = JSON.stringify(plansConfig, null, 2);
                
                // Create GitHub web editor URL for creating a new file
                const githubWebEditorUrl = `https://github.com/F8ai/formul8-multiagent/new/${branchName}?filename=config/plans.json&value=${encodeURIComponent(plansJson)}`;
                
                // Create PR creation URL
                const prCreateUrl = `https://github.com/F8ai/formul8-multiagent/compare/main...${branchName}`;
                
                showStatus('✅ Configuration prepared! Opening GitHub editor...', 'success');
                
                const prInfo = `
                    <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745;">
                        <h4>🎉 Ready to Create Pull Request!</h4>
                        <p>Follow these steps to create your PR:</p>
                        <ol>
                            <li><strong>Create Branch & File:</strong> <a href="${githubWebEditorUrl}" target="_blank" style="color: #007bff; text-decoration: underline;">Open GitHub Editor</a></li>
                            <li><strong>Commit the file</strong> with message: <code>Update plans configuration</code></li>
                            <li><strong>Create PR:</strong> <a href="${prCreateUrl}" target="_blank" style="color: #007bff; text-decoration: underline;">Create Pull Request</a></li>
                        </ol>
                        <p><strong>Branch Name:</strong> <code>${branchName}</code></p>
                        <p><strong>Files to Update:</strong></p>
                        <ul>
                            <li><code>config/plans.json</code> (main file)</li>
                            <li><code>config/langchain-{plan}.json</code> (run sync script after PR is created)</li>
                        </ul>
                        <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                            <strong>After creating the PR, run this command to sync langchain files:</strong><br>
                            <code style="background: #e9ecef; padding: 2px 4px; border-radius: 3px;">node scripts/sync-plans-to-langchain.js</code>
                        </div>
                    </div>
                `;
                
                document.getElementById('status').innerHTML += prInfo;
                
                // Auto-open the GitHub editor
                window.open(githubWebEditorUrl, '_blank');
                
                originalConfig = JSON.parse(JSON.stringify(plansConfig));
            } catch (error) {
                console.error('Error preparing pull request:', error);
                showStatus('Error preparing pull request: ' + error.message, 'error');
            }
        }

        // Reset configuration
        function resetConfiguration() {
            if (confirm('Are you sure you want to reset all changes?')) {
                plansConfig = JSON.parse(JSON.stringify(originalConfig));
                renderTable();
                showStatus('Configuration reset to original state', 'info');
            }
        }

        // Agent drag and drop handlers
        let draggedAgentRow = null;
        let draggedAgentKey = null;
        let draggedSectionKey = null;

        function handleAgentDragStart(e) {
            draggedAgentRow = e.target;
            draggedAgentKey = e.target.dataset.agentKey;
            draggedSectionKey = e.target.dataset.sectionKey;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleAgentDragEnd(e) {
            e.target.classList.remove('dragging');
            // Remove drag-over class from all rows
            document.querySelectorAll('.agent-row').forEach(row => {
                row.classList.remove('drag-over');
            });
            draggedAgentRow = null;
            draggedAgentKey = null;
            draggedSectionKey = null;
        }

        function handleAgentDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            // Add visual feedback
            const targetRow = e.target.closest('.agent-row');
            if (targetRow && targetRow !== draggedAgentRow) {
                targetRow.classList.add('drag-over');
            }
        }

        function handleAgentDrop(e) {
            e.preventDefault();
            
            const targetRow = e.target.closest('.agent-row');
            if (!targetRow || !draggedAgentKey || targetRow === draggedAgentRow) {
                return;
            }

            const targetAgentKey = targetRow.dataset.agentKey;
            const targetSectionKey = targetRow.dataset.sectionKey;
            
            // Don't allow dropping on the same section
            if (targetSectionKey === draggedSectionKey) {
                return;
            }

            // Move agent to new section
            moveAgentToSection(draggedAgentKey, draggedSectionKey, targetSectionKey);
            
            // Remove drag-over class
            targetRow.classList.remove('drag-over');
        }

        function moveAgentToSection(agentKey, fromSection, toSection) {
            // Update the agent sections configuration
            const agentSections = {
                f8: {
                    title: 'F8 Core Agents',
                    agents: [
                        'compliance',
                        'operations', 
                        'marketing',
                        'formulation',
                        'patent',
                        'sourcing',
                        'customer_success'
                    ]
                },
                beta: {
                    title: 'Beta Features',
                    agents: [
                        'science',
                        'spectra',
                        'metabolome'
                    ]
                },
                free: {
                    title: 'Free Plan Features',
                    agents: [
                        'ad'
                    ]
                },
                custom: {
                    title: 'Custom Agents',
                    agents: [
                        'future4200',
                        'mcr'
                    ]
                },
                admin: {
                    title: 'Admin Tools',
                    agents: [
                        'f8_slackbot',
                        'editor_agent'
                    ]
                }
            };

            // Remove agent from source section
            if (agentSections[fromSection]) {
                const sourceIndex = agentSections[fromSection].agents.indexOf(agentKey);
                if (sourceIndex > -1) {
                    agentSections[fromSection].agents.splice(sourceIndex, 1);
                }
            }

            // Add agent to target section
            if (agentSections[toSection]) {
                agentSections[toSection].agents.push(agentKey);
            }

            // Re-render the table with new organization
            renderTable();
            showStatus(`Moved ${agentsConfig.agents[agentKey]?.name || agentKey} to ${agentSections[toSection]?.title || toSection}`, 'success');
        }

        // Create pull request
        async function createPullRequest() {
            try {
                showStatus('Creating pull request...', 'info');
                
                const response = await fetch('/api/plans/pr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: 'Update Plans Configuration',
                        description: 'Updated agent access for pricing plans',
                        changes: plansConfig
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus(`Pull request created: ${result.prUrl}`, 'success');
                } else {
                    throw new Error('Failed to create pull request');
                }
            } catch (error) {
                console.error('Error creating pull request:', error);
                showStatus('Error creating pull request: ' + error.message, 'error');
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        // Start editing a plan field
        function startEditing(planKey, field) {
            const element = document.querySelector(`[data-plan="${planKey}"][data-field="${field}"]`);
            if (!element || element.classList.contains('editing')) return;
            
            const currentValue = element.textContent;
            element.classList.add('editing');
            
            // Create input element
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'editable-input';
            input.value = currentValue;
            
            // Replace content with input
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            
            // Handle save on blur or enter
            const saveEdit = () => {
                const newValue = input.value.trim();
                if (newValue !== currentValue) {
                    updatePlanField(planKey, field, newValue);
                }
                element.textContent = newValue;
                element.classList.remove('editing');
            };
            
            // Handle cancel on escape
            const cancelEdit = () => {
                element.textContent = currentValue;
                element.classList.remove('editing');
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        // Update a plan field in the configuration
        function updatePlanField(planKey, field, value) {
            if (!plansConfig.plans[planKey]) {
                plansConfig.plans[planKey] = {};
            }
            
            if (field === 'name') {
                plansConfig.plans[planKey].name = value;
            } else if (field === 'price') {
                plansConfig.plans[planKey].price = value;
            } else if (field === 'description') {
                plansConfig.plans[planKey].description = value;
            }
            
            // Update the display
            const element = document.querySelector(`[data-plan="${planKey}"][data-field="${field}"]`);
            if (element) {
                element.textContent = value;
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadConfigurations);
    </script>
</body>
</html><!-- Updated Sun Oct 12 10:36:29 EDT 2025 -->
